%
% Copyright (c) 2001-2005,2009 LAAS/CNRS                   --  Thu Oct 18 2001
% All rights reserved.                                     Anthony Mallet
%
% This document is a translation of the French documentation of GenoM,
% originally written by Sara Fleury and Matthieu Herrb.
%
% Redistribution  and  use in source   and binary forms,  with or without
% modification, are permitted provided that  the following conditions are
% met:
%
%   1. Redistributions  of  source code must  retain  the above copyright
%      notice, this list of conditions and the following disclaimer.
%   2. Redistributions in binary form must  reproduce the above copyright
%      notice,  this list of  conditions and  the following disclaimer in
%      the  documentation   and/or  other  materials   provided with  the
%      distribution.
%
% THIS SOFTWARE IS PROVIDED BY THE  AUTHOR AND CONTRIBUTORS ``AS IS'' AND
% ANY  EXPRESS OR IMPLIED WARRANTIES, INCLUDING,  BUT NOT LIMITED TO, THE
% IMPLIED WARRANTIES   OF MERCHANTABILITY AND  FITNESS  FOR  A PARTICULAR
% PURPOSE ARE DISCLAIMED.  IN NO  EVENT SHALL THE AUTHOR OR  CONTRIBUTORS
% BE LIABLE FOR ANY DIRECT, INDIRECT,  INCIDENTAL, SPECIAL, EXEMPLARY, OR
% CONSEQUENTIAL DAMAGES (INCLUDING,  BUT  NOT LIMITED TO, PROCUREMENT  OF
% SUBSTITUTE  GOODS OR SERVICES;  LOSS   OF  USE,  DATA, OR PROFITS;   OR
% BUSINESS  INTERRUPTION) HOWEVER CAUSED AND  ON ANY THEORY OF LIABILITY,
% WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
% OTHERWISE) ARISING IN ANY WAY OUT OF THE  USE OF THIS SOFTWARE, EVEN IF
% ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
%
% $Id$
%

A module is described with a particular syntax  in a file whose name ends
in ``dot   gen'' (\texttt{.gen}).  In this   chapter, we will  write  a test
module which we will call ``demo''.  Thus the file describing this module
will be  called  \texttt{demo.gen}.  The next  sections  explain  how such a
module is generated and used.

% -----------------------------------------------------------------------
\section{Principle of the module generation}
\label{sec|session|principle}

One can distinguish two main parts in a module:

\begin{itemize}
   \item A \emph{server}, which encapsulates algorithms and is generated
automatically by \GenoM\ from the description file,
   \item The set of \emph{algorithms} that you have developed, and that
will be included into the module.
\end{itemize}

To combine these two parts and form  a complete module, the definition of
functions that  will interface the server and  the algorithms together is
required (at the moment  only \texttt{C}  functions are  supported).  These
functions are  called ``codels'' (which  stands for \emph{code elements}),
and they represent the \emph{smallest} grain size  the server will be able
to manipulate.

The first  time \GenoM\  is called,  it generates empty  codels. They are
fully  functional, but do  nothing. It's up to  you to fill  them in with
your own code.

\bigbreak

\begin{figure}[htbp]
\centering
\includegraphics[width=0.8\hsize]{fig/cycle-en}
\caption{Development cycle and separation between server and codels.}
\label{fig|session|cycle}
\end{figure}

To help   you distinguish  between   the  server   and the   codels,  the
corresponding files are placed in two separate directories. The first one
is called \texttt{server/} and contains all  the code generated by \GenoM. The
second directory is called \texttt{codels/} and  contains the codels   ---
initially a template generated by \GenoM\ but never touched again once
you have filled them in.

\bigbreak

The figure~\ref{fig|session|cycle} shows a synthetic view of the
separation between \texttt{server/} and \texttt{codels/} and also represent a
typical development cycle~:

\begin{description}
   \item\textbf{1. module description:} edition of the \texttt{.gen} file,
   \item{2. and 3. server generation and compilation},
   \item\textbf{4. write the codels that will invoke your algorithms},
   \item{5. and 6. compile the codels and link with the server},
   \item\textbf{7. test and use the module}.
\end{description}

Only the points \textbf{1}, \textbf{4} and \textbf{7} are in your charge. \GenoM\
writes for you   the \texttt{Makefile}s  and  handle the compilation of  the
various files.

Once you have  compiled a module,  you  can incrementally modify, add  or
remove services (back to  the first point) and  codels (back to the point
number 4).

% -----------------------------------------------------------------------
\section{An example}
\label{sec|session|example}

This section will  illustrate a concrete use  of \GenoM\ with  a ``demo''
module. This module  will  control a  mobile that  can translate  on  a 2
meters long rail. Some of the services the ``demo'' module offers are:

\begin{itemize}
   \item select the speed (between two symbolic values \texttt{DEMO\_SLOW}
and \texttt{DEMO\_FAST}),
   \item move the mobile for a given distance,
   \item read the current speed or position at any moment,
   \item suspend the motion,
   \item monitor particular positions and inform when the mobile goes
through these positions.
\end{itemize}

To implement this, we first create a directory named \texttt{demo/}. In that
directory we will write the description file \texttt{demo.gen}, which could
look like this (see next page):
\vfill\eject

\vbox to\textheight{\vfill
\begin{center}
\begin{cartouche}\small
\begin{verbatim}
/* -------------------------- MODULE DECLARATION --------------------------- */

module demo {
   number:            9000;            /* module id: unique number */
   internal_data:     DEMO_STR;        /* C typedef (defined below) */
   version:           "0.1";
   email:             "openrobots@laas.fr";
};


/* ------------- DEFINITION OF THE MODULE's INTERNAL DATABASE -------------- */

/* External definitions involved in the database definition */
#include "demoStruct.h"

/* The internal database */
typedef struct DEMO_STR {
   DEMO_STATE_STR   state;           /* Current state of the mobile */
                                     /* (position and speed) */
   DEMO_SPEED       speedRef;        /* Speed reference */
   double           distRef;         /* Distance reference */
   double           monitor;         /* Positions monitors */
}DEMO_STR;
 

/* ------------------ SERVICES DEFINITION: The REQUESTS -------------------- */

/* Control request: modify the default speed */
request SetSpeed {
   type:                control;              /* request's type  */
   input:               speed::speedRef;      /* input: speed chosen */
   codel_control:      demoSetSpeedCntrl;    /* codel for validity checks */
   fail_reports:            INVALID_SPEED;        /* possible error messages */
};

/* Control request: return the default speed */
request GetSpeed {
   type:                control;              /* request's type */
   output:              speed::speedRef;      /* output: the speed */
};

/* Control request:  interrupt the mobile */
request Stop {
   type:                control;              /* request's type */
   interrupt_activity:   Goto;         /* request to interrupt */
};
\end{verbatim}
\end{cartouche}
\end{center}
\vfill
\hfill continued on next page...
}
\eject

\vbox to\textheight{
... continuation of previous page
\vfill
\begin{center}
\begin{cartouche}\small
\begin{verbatim}
/* Execution request: translate of a given distance */
request Goto {
   type:                  exec;              /* request's type */
   input:                 distance::distRef; /* input: distance */
   codel_control:         demoGotoCntrl;     /* codel for validity checks */
   fail_reports:          TOO_FAR_AWAY;      /* possible error messages */
   codel_start:           demoGotoStart;     /* initialization codel */
   codel_main:            demoGotoMain;      /* main codel */
   codel_end:             demoGotoEnd;       /* termination codel */
   codel_inter:           demoGotoInter;     /* interruption codel */
   interrupt_activity: Goto;              /* incompatible requests */
   exec_task:             MotionTask;        /* task (thread) executing
                                              * the codel */
};

/* Execution request: monitor a particular mobile's position */
request Monitor {
   type:                  exec;                 /* request's type */
   input:                 position::monitor;    /* inputs: position */
   output:                position::state.position; /* outputs: actual pos. */
   codel_main:            demoMonitorExec;      /* main codel */
   fail_reports:          TOO_FAR_AWAY;         /* possible error messages */
   interrupt_activity: none;                 /* no incompatible requests */
   exec_task:             MotionTask;           /* task (thread) */
};


/* ------------------------ POSTERS DECLARATION  --------------------------- */

/* Poster that exports the current state of the mobile */
poster Mobile {
   update:               auto;
   data:                 state::state, ref::distRef;
   exec_task:            MotionTask;
};

 
/* --------------------- EXECUTION TASKS DECLARATION ----------------------- */

/* Only one task (or thread) */
exec_task MotionTask {
   period:               20;
   delay:                0;
   priority:             100;
   stack_size:           2000;
   c_init_func:          demoInit;
};
\end{verbatim}
\end{cartouche}
\end{center}
\vfill
}
\eject

The file \texttt{demo.gen} is made up of five parts, each of them being
identified with a keyword (these keywords are explained in detail in
chapter \ref{cha|edit}):

\begin{center}\begin{tabular}{llll}
1.& \texttt{module} & module declaration \\
\noalign{\vskip10pt}

2.& \parbox[t]{4cm}{
\hbox{\texttt{\#include}} and
\hbox{\texttt{typedef struct}}} & \parbox[t]{9cm}{\texttt{C} include
statement for the definition of structures and declaration of the
internal database} \\
\noalign{\vskip10pt}

3.& \texttt{request} & \parbox[t]{9cm}{requests definition: the five
services offered by the module} \\
\noalign{\vskip10pt}

4.&  \texttt{poster} & \parbox[t]{9cm}{posters  definition:   posters  are
exported  data structures  that let information  on the  mobile  state be
available for other modules} \\
\noalign{\vskip10pt}

5.& \texttt{exec\_task} & \parbox[t]{9cm}{execution task declaration (a
thread for Unix) that take care of codel execution}\\
\end{tabular}\end{center}

\bigbreak

The \texttt{\#include demoStruct.h} statement (the  second part above) works
as in \texttt{C} and  includes the corresponding \texttt{C} header file.  This
file contains   all the necessary   \texttt{typedef} declarations  for  the
definition of the  internal database. These structures  are  then used by
the \texttt{request} and the \texttt{poster} declarations.

In this example,  the file \texttt{demoStruct.h} contains the definition of
\texttt{DEMO\_STATE\_STR} and  \texttt{DEMO\_SPEED}. This   file is preferably
located in the same directory as \texttt{demo.gen},  since it contributes to
the definition of the module interface.

\bigbreak

\begin{center}
\begin{cartouche}\small
\begin{verbatim}
#ifndef DEMO_STRUCT_H
#define DEMO_STRUCT_H

/* Current state of the mobile */
typedef struct DEMO_STATE_STR {
   double position;              /* current position */
   double speed;                 /* current speed */
}DEMO_STATE_STR;

/* Admissible speeds */
typedef enum DEMO_SPEED{
  DEMO_SLOW,                     /* low speed */
  DEMO_FAST                      /* high speed */
} DEMO_SPEED;

#endif /* DEMO_STRUCT_H */
\end{verbatim}
\end{cartouche}
\end{center}


% -----------------------------------------------------------------------
\section{Module generation}
\label{sec|session|generate}

The  generation step is done  through the \texttt{genom} command invocation.
When a module is to be generated for the  first time, \texttt{genom} must be
invoked  with the \texttt{-i} option, which installs  the initial files (in
particular, it installs the codels templates).  Here is a sample run, for
the \texttt{demo} example:

\begin{center}
\begin{cartouche}\small
\begin{verbatim}
blues% genom  -i demo
genom demo.gen: info: array MonitorInput added in SDI for request Monitor
genom demo.gen: info: array MonitorOutput added in SDI for request Monitor
perl -w ./demo.pl

Updating top directory
  creating acinclude.user.m4
  creating local.mk.in
  creating configure.ac.user
  creating autogen
  creating Makefile.in

Updating codels
  demoMotionTaskCodels.c changed, skipping
  demoCntrlTaskCodels.c changed, skipping
  Makefile.in changed, skipping

Updating autoconf
  creating genom.mk
  creating install-sh
  creating mkinstalldirs
  creating config.sub
  creating config.guess
  creating ltmain.sh
  creating robots.m4
  creating libtool.m4
  creating config.posix.mk
  creating config.rtai.mk

Updating server
  creating Makefile.in
  creating demoType.h
  creating demoError.h
  creating demoError.c
  creating demoMsgLib.c
  creating demoConnectLib.c
  creating demoMsgLib.h
...
Creating build environment ...
  * Running aclocal
  * Running autoconf


If you already have a build of this module, do not forget to
reconfigure (for instance by running ./config.status --recheck)

Done.

\end{verbatim}
\end{cartouche}
\end{center}

\bigbreak

Some comments on this run:

\begin{enumerate}
   \item  The \texttt{.gen}  extension   needs   not  to be    explicitely
   given. \GenoM\ appends it automatically.

   \item \GenoM\ creates two directories and a great number of files. You
   do not need to know them all, and they will be described later in this
   document (they are also described in the appendix \ref{anx|files}).
\end{enumerate}

\textbf{From now on, the module is ready to  be compiled and run}, but let's
look at the result of the execution of \texttt{genom}:

\begin{center}
\begin{cartouche}\small
\begin{verbatim}
blues% ls -F
CVS/               autoconf/  configure*         demoConst.h   server/
Makefile.in        autogen*   configure.ac.user  demoStruct.h  xaff/
acinclude.user.m4  codels/    demo.gen           local.mk.in
\end{verbatim}
\end{cartouche}
\end{center}

\bigbreak
\GenoM\ created two new directories \texttt{server/} and \texttt{codels/}, and 
several
new files \texttt{configure}, \texttt{Makefile.in} and several other
autoconf related files. 

\begin{itemize}
   \item The \texttt{server/} directory  is entirely dedicated to \GenoM\ (and
   that is the only  such directory).  It contains  all the  \emph{server}
   code (see figure \ref{fig|session|cycle}), and you do not need to look
   into it, except if you are looking for some specific information. This
   document will describe this directory later.

   \item Algorithms (or a part of them) are grouped in the directory 
\texttt{codels/}. It has been  installed by the  \texttt{-i} option. The files in
   that directory give you a template to start from, and also let \GenoM\
   produce a module even if you still do not have written a single line of
   code. From now  on,  that directory belongs to  you  and \GenoM\ never
   goes into it again (except if you regenerate  the module with the 
\texttt{-i} option).

   \item The  \texttt{Makefile.in} and \texttt{configure.ac.user} files
are  also under your control. These are the
   main files which are used for the compilation of the module.

\end{itemize}


% -----------------------------------------------------------------------
\section{Module compilation}
\label{sec|session|compile}

There are two steps in compilation of the module:
\begin{itemize}
\item \emph{configuration} of the module, which is done using the GNU
autotools framework, by running the \texttt{configure} script.
\item \emph{compilation} itself, controlled by the \texttt{Makefile}
generated by the previous step. 
\end{itemize}

\subsection{Build directory}
In order to keep objects files separated from the sources, for
instance when you want to generate the module for several different
machine architectures, or just in order to have a simple mean to clean
up everything that was produced during the building phase, it is
strongly recommended to create a separate \emph{build} directory and
run every command from there. 

\begin{center}
\begin{cartouche}\small
\begin{verbatim}
blues% mkdir obj
blues% cd obj
\end{verbatim}
\end{cartouche}
\end{center}

\subsection{Configuration}

All the  openrobots software  and tools are  generally  installed in a specific
directory           (for       instance    \texttt{\$\{HOME\}/openrobots     or
\texttt{/usr/local/openrobots}}. This is the  main information that needs to be
specifed to the \texttt{configure} script. Don't forget to run
\texttt{configure} from the build directory.

\begin{center}
\begin{cartouche}\small
\begin{verbatim}
blues% cd obj
blues% ../configure --prefix=${HOME}/openrobots
checking build system type... i686-pc-linux-gnu
checking host system type... i686-pc-linux-gnu
checking for gcc... gcc
checking for C compiler default output file name... a.out
checking whether the C compiler works... yes
checking whether we are cross compiling... no
checking for suffix of executables... 
checking for suffix of object files... o
...
configure: creating ./config.status
config.status: creating config.mk
config.status: creating Makefile
config.status: creating codels/Makefile
config.status: creating server/Makefile
config.status: creating demo.pc
config.status: creating local.mk
\end{verbatim}
\end{cartouche}
\end{center}

\subsection{Compilation itself}

To compile the module, just run \texttt{make} from the build directory. The GNU
make utility is required, but this is the standard make on Linux systems. On
different Unixes, it may be installed under a different name, usually
\texttt{gmake} or \texttt{gnumake}.

\begin{center}
\begin{cartouche}\small
\begin{verbatim}
blues% make
make all-posix
make[1]: Entering directory `/home/matthieu/openrobots/modules/demo/obj'
make[2]: Entering directory `/home/matthieu/openrobots/modules/demo/obj/server'
mkdir -p posix-obj
/home/matthieu/openrobots/i386-linux/bin/mkdep -c"gcc" -oposix-obj/dependencies -dposix-obj -t.lo -DUNIX    -I. -I../.. -I../../server -I/home/matthieu/openrobots/i386-linux/include   ../../server/demoCntrlTask.c ../../server/demoModuleInit.c ../../server/demoMotionTask.c ../../server/demoPosterWriteLib.c
make dependencies for ../../server/demoCntrlTask.c...
make dependencies for ../../server/demoModuleInit.c...
make dependencies for ../../server/demoMotionTask.c...
...
creating posix-obj/demo
make[2]: Leaving directory `/home/matthieu/openrobots/modules/demo/obj/codels'
make[1]: Leaving directory `/home/matthieu/openrobots/modules/demo/obj'
blues%
\end{verbatim}
\end{cartouche}
\end{center}

\subsection{Installation}
The built binaries and libraries (and some associated files) need to
be copied to their final locations. This is achieved by executing
\texttt{make install}. Depending on your environment, this may require
\emph{root} priviledges.

\begin{center}
\begin{cartouche}\small
\begin{verbatim}
blues% su
password:
blues# make install
blues% make install
make install-posix
make[1]: Entering directory `/home/matthieu/openrobots/modules/demo/build'
make[2]: Entering directory `/home/matthieu/openrobots/modules/demo/build/server'
../../autoconf/mkinstalldirs /usr/local/openrobots/lib
...
ranlib /usr/local/openrobots/lib/libdemoClient.a
chmod 644 /usr/local/openrobots/lib/libdemoClient.a
PATH="$PATH:/sbin" ldconfig -n /usr/local/openrobots/lib
----------------------------------------------------------------------
Libraries have been installed in:
   /usr/local/openrobots/lib
...
../autoconf/mkinstalldirs /usr/local/openrobots/lib/pkgconfig
/usr/bin/install -c demo.pc  /usr/local/openrobots/lib/pkgconfig
blues# 
\end{verbatim}%$
\end{cartouche}
\end{center}
% -----------------------------------------------------------------------
\section{Module execution}
\label{sec|session|exec}

Once the server and the codels are compiled and  the link edition between
them has been done,  the \texttt{demo} module is  ready to be executed.  The
module is located in the  \texttt{bin} sub-directory of the directory
specified as prefix in the 
configuration step.     (see
figure~\ref{fig|session|cycle}). This is an executable whose name is
the   name   of the     module  (i.e. \texttt{demo}).

The   next two sections   present a step-by-step   tutorial on how to run
modules.

\subsection{Execution under Unix}
\label{ssec|exec|unix}

\paragraph{Module startup:}

\begin{enumerate}
\item Launch \texttt{h2 init} to initialize communication libraries.

\begin{center}\begin{cartouche}\small\begin{verbatim}
blues% h2 init
Initializing pocolibs devices: OK
pocolibs execution environment version 2.1
Copyright (c) 1999-2005 CNRS-LAAS
blues%
\end{verbatim}\end{cartouche}\end{center}

Note: if you get the following message, it is usually sufficient to
answer \texttt{n}:

\begin{center}\begin{cartouche}\small\begin{verbatim}
blues% h2 init
Initializing pocolibs devices: 
pocolibs devices already exist on this machine.
Do you want to delete and recreate them (y/n) ? y
OK
pocolibs execution environment version 2.1
Copyright (c) 1999-2005 CNRS-LAAS
\end{verbatim}\end{cartouche}\end{center}

\item Launch the module.

\begin{center}\begin{cartouche}\small\begin{verbatim}
blues% demo -b
pocolibs execution environment version 2.1
Copyright (c) 1999-2005 CNRS-LAAS
demo: spawning control task.
demoCntrlInitTask: created mailbox
demoCntrlInitTask: initialized mailbox as a server
demoCntrlInitTask: installed requests
demoCntrlInitTask: installed abort request
demoCntrlInitTask: created control poster
demo: spawning task demoMotionTask.
demoMotionTaskInitTaskFunc: timer allocated
demoMotionTaskInitTaskFunc: timer started
demoMotionTaskInitTaskFunc: posters created
demoMotionTaskInitTaskFunc: client posters initialized
demoMotionTaskInitTaskFunc: ok
demo: all tasks are spawned
blues% 
\end{verbatim}\end{cartouche}\end{center}

\item You're done! So... what?
\end{enumerate}

So the module is running and ready to serve requests. We will see how
this can be done with the small interactive test program \texttt{demoTest}.

\paragraph{Client startup: the interactive test program \texttt{demoTest}}

\begin{description} % for alignment
\item ~
\begin{center}\begin{cartouche}\small\begin{verbatim}
demoTest 1
\end{verbatim}\end{cartouche}\end{center}
\end{description}

Note: if  you launch several clients, remember  to  change the number (we
choose ``1'' in the example above).

\paragraph{Killing the module:}

\begin{description} % for alignment
\item ~
\begin{center}\begin{cartouche}\small\begin{verbatim}
blues% killmodule demo
\end{verbatim}\end{cartouche}\end{center}
\end{description}

At this point you can start a new instance of the module.

\paragraph{Cleaning everything:}

\begin{description} % for alignment
\item ~
\begin{center}\begin{cartouche}\small\begin{verbatim}
blues% h2 end
\end{verbatim}\end{cartouche}\end{center}
\end{description}

