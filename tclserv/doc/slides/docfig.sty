%%
%% Copyright (C) 2000 LAAS/CNRS 
%%
%% Anthony Mallet - Thu Oct 19 2000
%%

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{docfig}[2001/05/30 v1.2 LaTeX2e docfig package]
\RequirePackage{keyval,graphicx,psfrag,color}

% test whether pdf or dvi output is requested
\ifx\pdfoutput\@undefined
   \def\DF@ext{eps}
\else
   \ifnum\pdfoutput>0\def\DF@ext{pdf}\else\def\DF@ext{eps}\fi
\fi
\def\DF@dviext{eps}

\newif\ifDF@scale
\newif\ifDF@psfrag
\def\DF@defaultdpi{72}
\def\DF@defaulscale{\global\DF@scaletrue}
\def\DF@defaultpsfrag{\global\DF@psfragfalse}

\define@key{DFO}{dpi}{%
   \typeout{DocFig package uses #1dpi images}%
   \def\DF@defaultdpi{#1}}
\define@key{DFO}{resample}[true]{%
   \typeout{DocFig package uses scaled figures}%
   \def\DF@defaulscale{\global\DF@scaletrue}}
\define@key{DFO}{noresample}[true]{%
   \typeout{DocFig package uses unscaled figures}%
   \def\DF@defaulscale{\global\DF@scalefalse}}
\define@key{DFO}{pdftex}[true]{%
   \typeout{DocFig package configured for pdftex}%
   \gdef\DF@pdftex{1}}

\define@key{DFO}{draft}[true]{\Gin@drafttrue}
\define@key{DFO}{final}[true]{\Gin@draftfalse}

\def\DF@gslash#1{\ifx#1/\else#1\fi}
\def\DF@firstof#1{\expandafter\DF@first@f#1, \noexpand\@@}
\def\DF@first@f#1,#2\@@{#1}

% --- Fonts for figures -------------------------------------------------
% bad

\newcommand{\figfont}[3]{%
%   \@warning{You should not use the command figfont anymore}%
   \fontsize{#1}{#1}\usefont{T1}{phv}{#2}{#3}\selectfont%
}
\def\docfigfont{\fontfamily{phv}\selectfont}

% --- Language ----------------------------------------------------------

\def\ifdoclang#1#2{%
   \expandafter\ifx\csname l@#1\endcsname\relax\else%
      \expandafter\ifnum\csname l@#1\endcsname=\language%
	 #2\relax%
      \fi%
   \fi%
}

\edef\tmpa{\DF@firstof{\@filelist}}
\filename@parse{\tmpa}
\ifx\filename@ext\@clsextension
   \def\DF@docclass{}
   \ifx\@classoptionslist\undefined\else
      \def\DF@docclass{[}
      \def\@avoid{landscape}
      \@for\@temp:=\@classoptionslist\do{
	 \ifx\@temp\@avoid\else
            \edef\DF@docclass{\DF@docclass,\@temp}
	 \fi
      }
      \edef\DF@docclass{\DF@docclass]}
   \fi
   \edef\DF@docclass{\string{\filename@area\filename@base\string}}
\else
   \@warning{Cannot find class for psfrag and pdf output}%
   \let\DF@docclass\relax
\fi

% --- Graphics inclusion ------------------------------------------------

\newdimen\DF@width
\newdimen\DF@height
\newcount\DF@figcnt\DF@figcnt0

\def\docfig{\@ifnextchar[\@docfig{\@docfig[]}}
\def\@docfig[#1]#2{%
   \let\@igol\@empty%
   \let\DF@dpi\DF@defaultdpi%
   \DF@defaulscale%
   \DF@defaultpsfrag%
   \let\DF@thewidth\@empty%
   \let\DF@theheight\@empty%
   \let\DF@deps\@empty%
   \setkeys{DF}{#1}%
   \IfFileExists{#2}{%
      \filename@parse{#2}%
      \def\genfile{\expandafter\DF@gslash\filename@area\jobname-\the\DF@figcnt-\filename@base}%
      \ifDF@scale\docfig@scale\else\ifx\filename@ext\DF@ext%
         \def\genfile{\filename@area\filename@base}%
      \fi\fi%
      {\docfig@psfrag{\filename@area\filename@base.psfrag}{\genfile.\DF@ext}%
      \docfig@depend{\genfile.\DF@ext}{#2}%
      \IfFileExists{\genfile.\DF@ext}{%
	 \edef\@igol{\noexpand\includegraphics[\@igol]{\genfile.\DF@ext}}%
	 \@igol%
      }{%
	 \@addtofilelist{\genfile.\DF@ext}%
         \@latex@warning@no@line{Rerun to get images generated : 
	       image `\genfile.\DF@ext' doesn't exist.}%
      }}%
   }{\@latex@error{File `#2' not found}{}}%
   \global\advance\DF@figcnt by 1%
}

\def\docfigoption#1{%
   \ifx\@igol\undefined%
      \@latex@error{Sorry, not in a docfig context}{}%
   \else%
      \edef\@igol{\@igol,#1}%
   \fi%
}

\def\docfig@depend#1#2{%
   \ifx\adddepsrule\@undefined\else%
      \edef\@tempa{#1}\edef\@tempb{#2}%
      \ifx\@tempa\@tempb\else\adddepsrule{#1}{#2}\fi%
      \ifx\DF@deps\@empty\else%
         \adddepsrule{#1}{CONVERT_OPT=\DF@deps}%
      \fi%
   \fi%
}

\def\docfig@scale{%
   \ifx\adddepsrule\@undefined\else\ifDF@scale%
      \edef\DF@deps{\DF@deps\space-geometry \DF@thewidth\DF@theheight}%
      \edef\DF@deps{\DF@deps\space-density \DF@dpi}%
   \fi\fi%
}

\def\docfig@depths#1{%
   \ifx\adddepsrule\@undefined\else%
      \edef\DF@deps{\DF@deps\space-depths \string"#1\string"}%
   \fi%
}

\def\docfig@psfrag#1#2{%
   \ifDF@psfrag%
      \def\tempa{true}\ifx\DF@thepsfrag\tempa%
	 \docfig@psfragi{#1}{#2}%
      \else%
	 \docfig@psfragi{\DF@thepsfrag}{#2}%
      \fi%
   \fi%
}

\def\docfig@psfragi#1#2{%
   \IfFileExists{#1}{%
      \ifx\DF@ext\DF@dviext%
	 \docfigfont\input{#1}%
      \else%
	 \ifx\adddepsrule\@undefined%
	    \@warning{PSFrag `#1' not used}%
	 \else%
            \adddepsrule{#2}{#1}%
	    \ifx\bbl@main@language\undefined%
	       \edef\DF@deps{\DF@deps\space-psfrag default}%
	    \else%
	       \edef\DF@deps{\DF@deps\space-psfrag \languagename}%
	    \fi%
	    \ifx\DF@docclass\relax\else%
	       \edef\DF@deps{\DF@deps\space-class '\DF@docclass'}%
	    \fi%
	 \fi%
      \fi%
   }{\@warning{File `#1' not found}}%
}


% options
\define@key{DF}{dpi}{\def\DF@dpi{#1}}
\define@key{DF}{width}{%
   \DF@width#1\def\DF@thewidth{\the\DF@width}%
   \edef\@igol{\@igol,width=#1}}
\define@key{DF}{height}{%
   \DF@height#1\def\DF@thewidth{,\the\DF@height}%
   \edef\@igol{\@igol,height=#1}}
\define@key{DF}{resample}[true]{\global\DF@scaletrue}
\define@key{DF}{noresample}[true]{\global\DF@scalefalse}
\define@key{DF}{psfrag}[true]{\global\DF@psfragtrue\def\DF@thepsfrag{#1}}
\define@key{DF}{depth}{\docfig@depths{#1}}

% include graphics options (passed as is)
\define@key{DF}{totalheight}{\edef\@igol{\@igol,totalheight=#1}}
\define@key{DF}{scale}{\edef\@igol{\@igol,scale=#1}}
\define@key{DF}{angle}{\edef\@igol{\@igol,angle=#1}}
\define@key{DF}{origin}{\edef\@igol{\@igol,origin=#1}}
\define@key{DF}{bb}{\edef\@igol{\@igol,bb=#1}}
\define@key{DF}{viewport}{\edef\@igol{\@igol,viewport=#1}}
\define@key{DF}{trim}{\edef\@igol{\@igol,trim=#1}}
\define@key{DF}{draft}{\edef\@igol{\@igol,draft=#1}}
\define@key{DF}{final}{\edef\@igol{\@igol,final=#1}}
\define@key{DF}{keepaspectratio}{\edef\@igol{\@igol,keepaspectratio=#1}}

% --- Options -----------------------------------------------------------

\def\DFProcessOptions#1{%
  \let\@tempa\@empty
  \@for\CurrentOption:=\@classoptionslist\do{%
    \@ifundefined{KV@#1@\CurrentOption}%
    {}{\edef\@tempa{\@tempa,\CurrentOption,}}}%
  \edef\@tempa{%
    \noexpand\setkeys{#1}{\@tempa\@ptionlist{\@currname.\@currext}}}%
  \@tempa
  \AtEndOfPackage{\let\@unprocessedoptions\relax}}
\DFProcessOptions{DFO}\relax
