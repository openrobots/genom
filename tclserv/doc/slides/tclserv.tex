%%
%% Anthony Mallet - Fri Dec  6 2002
%% Copyright (C) 2002-2009 LAAS/CNRS 
%%
\documentclass[a4paper,landscape,smooth]{show}
\usepackage{depend,aeguill,cartouche}
\usepackage[dpi=100,resample]{docfig}
\usepackage[T1]{fontenc}
\usepackage[latin1]{inputenc}
\usepackage{pp4/pause}

\context{\vfill}
\title{\Huge tclServ}
\author{Anthony Mallet, Sara Fleury}
\date{November 2009}

\newcommand{\tclex}[2]{\texttt{#1}\\$\rightarrow$ \texttt{#2}}

\begin{document}
\maketitle

\def\figurepath{./:./fig}
\graphicspath{{./:./fig/}}

% =======================================================================

\begin{part}{Introduction}{}
   \vfill
   {\bf Motivations}
   \begin{bitemize}{color@bulle}
      \item Developing complex systems in a {\bf modular} and
	    {\bf incremental} way.
      \item {\bf Dynamic configuration}.
   \end{bitemize}
   \vfill
   {\bf Architecture}
   \begin{bitemize}{color@bulle}
      \item  Functional level $\rightarrow$ GenoM components (modules).
      \item System state,  inter-components coherency, configuration,
	    communication $\rightarrow$ execution control.
      \item Application $\rightarrow$ decisional level.
   \end{bitemize}
   \vfill
\end{part}

\begin{tslide}{tclServ}
   \vfill
   \begin{bitemize}{color@bulle}
      \item Fast module tests. Equivalent to
	    "test" programs.
      \item Simple scripts to coordonnate several modules.
      \item Graphical user interfaces (Tk).
   \end{bitemize}
   \vfill
\end{tslide}

% =======================================================================

\begin{part}{tclServ}{Architecture}
   \vfill
    \includegraphics[width=.9\columnwidth]{./fig/tclServ.pdf}
   \vfill
\end{part}

% -----------------------------------------------------------------------

\begin{tslide}{Quick start}
   \vfill
   \begin{bitemize}{color@bulle}
      \item On each machine executing GenoM modules:\\
   \begin{cartouche}
	 \texttt{tclserv}
   \end{cartouche}

      \item On the ``master'' machine:
	   \begin{bitemize}{color@bulle}
	       \item    Tcl shell linked with \texttt{editLine}:
\begin{cartouche}
\texttt{eltclsh -package genom}
\end{cartouche} 
	       \item Or, shell linked with the graphical toolkit
		     \texttt{Tk} and with \texttt{editLine}:
\begin{cartouche}
\texttt{elwish -package genom}
\end{cartouche} 

	   \end{bitemize}
   \end{bitemize}
   \vfill
\end{tslide}
% -----------------------------------------------------------------------

\begin{tslide}{To avoid multi-users interferences}
   \vfill
   {\bf To allow multiple \texttt{tclserv} running on a same machine.}

	Can occure when several users want to make independant tests on
	a same machine\\
	(If the users share modules thanks to {\tt H2DEV\_DIR}
	environment variable they can also share {\tt tclserv})

   {\bf Redefinition of the socket port number used to comunicate between \texttt{tclserv} and \texttt{eltclsh}:}
   \begin{bitemize}{color@bulle}
      \item Using the environment variable \texttt{TCLSERV\_PORT} for
	    both \texttt{tclserv} and \texttt{eltclsh}. \\
Eg, with \texttt{tcshell}:\\
   \begin{cartouche}
   \texttt{setenv TCLSERV\_PORT 1234}
   \end{cartouche}   
	 
      \item Or, for \texttt{tclserv}, using the  option {\tt -p
	    <port-number>} (it overwrites the environment variable \texttt{TCLSERV\_PORT})\\
   \begin{cartouche}
   \texttt{tclserv -p 1234}
   \end{cartouche}   

   \end{bitemize}

   \vfill
\end{tslide}

% -----------------------------------------------------------------------

\begin{tslide}{Connection to the server}
   \vfill
   \begin{cartouche}
   \texttt{connect {\em server}}
   \end{cartouche}   
   Connects to the server \texttt{\em server} where \texttt{tclserv} is running. One can connect with several servers (example~: \texttt{jido-base} and \texttt{jido-arm}).
   \vfill
   \begin{cartouche}
   \texttt{disconnect {\em server}}
   \end{cartouche}   
   Ends the connection with the server \texttt{\em server}.
   \vfill
   \begin{cartouche}
   \texttt{die}
   \end{cartouche}   
   Ends all the servers (\texttt{tclserv} processes) connected, and
   ends all the clients of all the servers.
   \vfill
\end{tslide}

% -----------------------------------------------------------------------

\begin{tslide}{Connections to the modules}
   \vfill
   \begin{cartouche}
   \texttt{lm {\em <module>} [on {\em <server>}] 
     [path {\em<path-on-tclsh-host-machine>}]\newline
     [rpath {\em <path-on-tclserv-target-machine>}]}
   \end{cartouche}   
   Loads the communications libraries with the \texttt{\em module}
   in the directory \texttt{\em path} on client side \\
   and \texttt{\em rpath} on tclserv side, by default the path are identical.
   \vfill
   \begin{cartouche}
   \texttt{mboxInit [{\em server}]}
   \end{cartouche}   
    Optional but useful to reconnect. 
    Starts the connections to the modules on server side, on the 
   \texttt{\em server} machine (or by default the last connected server).
   \vfill
   \begin{cartouche}
   \texttt{mboxEnd [{\em server}]}
   \end{cartouche}   
   Optional but useful to disconnect before reconnecting. 
   Ends the connections to the modules on the \texttt{\em
   server} (or by 
   default the last connected server).
   \vfill
\end{tslide}

% -----------------------------------------------------------------------
\begin{tslide}{Example}
\vfill
{\bf blues\% } h2 init\\
{\bf blues\% } demo -b\\
{\bf blues\% } tclserv\\
{\bf blues\% } eltclsh -package genom\\
{\bf eltclsh~>} connect localhost\\
{\bf eltclsh~>} lm demo\\
{\bf eltclsh~>} demo::MoveDistance 0.5\\
{\bf eltclsh~>} kill demo\\
{\bf eltclsh~>} die\\
{\bf blues\%} h2 end\\
\vfill
\end{tslide}
% ----------------------------------------------------------------------
\begin{tslide}{Example with 2 hosts}
   \vfill
   \parbox{0.45\linewidth}{\tt
      {\bf diligent->} h2 init\\
      {\bf diligent->} xr4000 -b\\
      {\bf diligent->} platine -b\\
      {\bf diligent->} tclserv -b\\
   }\hfill\parbox{0.45\linewidth}{\tt
      {\bf cabby->} h2 init\\
      {\bf cabby->} camera -b\\
      {\bf cabby->} tclserv\\
   }
   \vfill
   {\tt
      {\bf tcl->} connect diligent\\
      {\bf tcl->} lm platine path /usr/local/openrobots\\
      {\bf tcl->} lm xr4000 path /home/me/openrobots\\
      {\bf tcl->} mboxInit diligent\\
\\
      {\bf tcl->} connect cabby\\
      {\bf tcl->} lm camera path /usr/local/openrobots\\
      {\bf tcl->} mboxInit cabby\\
   }
   \vfill
\end{tslide}

% -----------------------------------------------------------------------

\begin{tslide}{Sending requests}
   \vfill
   \begin{cartouche}
      \tt {\em module}::{\em request} [-doc|-ack|-raw] {\em arg1} {\em arg2} ...
   \end{cartouche}
   Send the request {\tt\em request} to the module {\tt\em module}, with the
   arguments {\tt\em arg1} ... {\tt\em argn}. Returns a report and the
   result formated or not (option {\tt -raw}).

   With the option {\tt\em -doc}~: list the parameters expected by the
   request and their type.

   With the option {\tt\em -ack}~: does not block to wait the end of
   the request, and returns immediatly an idendifier to read the result
   later on.

   \vfill
   \begin{cartouche}
      \tt replyof {\em rqstId}
   \end{cartouche}
   Returns the result of the request {\tt\em rqstId}. Blocking.
   \vfill
\end{tslide}

% -----------------------------------------------------------------------

\begin{tslide}{Example}
   \vfill
   {\tt {\bf tcl->} lloco::GotoSpeed\\
   speedRef.v [0.000000] : 0.05\\
   speedRef.w [0.000000] : 0.0}
   \vfill
   {\tt {\bf tcl->} lloco::GotoSpeed 0.05 0.0}

   $\rightarrow$ blocked
   \vfill
   {\tt {\bf tcl->} set id [lloco::GotoSpeed -ack 0.05 0.0]\\
	\{lama0 0\}\\
	{\bf tcl->} puts "I'm not blocked"\\
	I'm not blocked\\
	{\bf tcl->} replyof \$id}

   $\rightarrow$ blocked
   \vfill
\end{tslide}

% -----------------------------------------------------------------------

\begin{tslide}{Controlling activites}
   \vfill
   \begin{cartouche}
      \tt abort {\em rqstId}
   \end{cartouche}
   Interrupts the request {\tt\em rqstId}. One can read the result with
   {\tt replyof \em rqstid}.
   \vfill
   \begin{cartouche}
      \tt kill {\em module}
   \end{cartouche}
   Kills the module, and returns a report. It is possible to re-start the
   module (by hand) and to connect again with {\tt mboxEnd; mboxInit}.
   \vfill
   \begin{cartouche}
      \tt cs::term {\em rqstId} {\em block}
   \end{cartouche}
   Sends back $0$ or $1$ if the request {\tt\em rqstId} is done. \\
   Non blocking if {\tt\em block} equal 0, blocking otherwise.
   \vfill
\end{tslide}

% -----------------------------------------------------------------------

\begin{tslide}{Requests results}
   \vfill
   The procedures to send requests return a list~:
   \begin{bitemize}{color@bulle}
      \item one report ({\bfseries\tt OK} or one error)
      \item the "flat" result structure of the request
   \end{bitemize}
   \vfill
   {\tt
   {\bf tcl->} camera::GetSaveParams \\
   status = OK\\
   saveP.directory = .\\
   saveP.num = 0\\
   saveP.format = CAMERA\_SAVE\_GZIPPED\_BITMAP\\
   saveP.jpegQuality = 75\\
   saveP.unused = 0\\
\\
   {\bf tcl->} camera::GetSaveParams -raw\\
   OK . 0 CAMERA\_SAVE\_GZIPPED\_BITMAP 75 0\\
   {\bf tcl->}}
   \vfill
\end{tslide}

% -----------------------------------------------------------------------

\begin{tslide}{Reading posters}
   \vfill
   \begin{cartouche}
      \tt {\em <module>}::{\em <poster>}{\em <struct>}PosterRead [-raw]
   \end{cartouche}
   Reads the structure {\tt\em struct} of poster {\tt\em poster} of module
   {\tt\em module}.
   \vfill
\end{tslide}


% -----------------------------------------------------------------------

\begin{tslide}{Automating things}
   \vfill
   {\bf eltclsh {\em file}}
   \begin{bitemize}{color@bulle}
      \item Executes {\tt\em file} and quits.
   \end{bitemize}
   \vfill
   {\bf \#!}
   \begin{bitemize}{color@bulle}
      \item \#!/usr/bin/env eltclsh
      \item chmod a+x
   \end{bitemize}
   \vfill
\end{tslide}

\vfill\eject\null\vfill\eject

\end{document}
